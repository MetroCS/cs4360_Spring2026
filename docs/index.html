<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CS 4360 Project Whiteboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .user-info {
            background: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .user-name {
            font-weight: bold;
            color: #667eea;
        }

        .controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
            margin-bottom: 20px;
        }

        button {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .btn-danger {
            background: #f56565;
            color: white;
        }

        .btn-danger:hover {
            background: #e53e3e;
        }

        .btn-secondary {
            background: #48bb78;
            color: white;
        }

        .btn-secondary:hover {
            background: #38a169;
        }

        .board {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .project-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: transform 0.2s, box-shadow 0.2s;
            position: relative;
        }

        .project-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 12px rgba(0,0,0,0.15);
        }

        .project-title {
            font-size: 1.4em;
            color: #2d3748;
            margin-bottom: 10px;
            font-weight: bold;
        }

        .project-proposer {
            color: #667eea;
            font-size: 0.9em;
            margin-bottom: 12px;
            font-weight: 600;
        }

        .project-description {
            color: #4a5568;
            line-height: 1.6;
            margin-bottom: 15px;
        }

        .project-actions {
            display: flex;
            gap: 8px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .project-actions button {
            padding: 8px 16px;
            font-size: 14px;
        }

        .choosers {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 2px solid #e2e8f0;
        }

        .choosers-title {
            font-weight: bold;
            color: #2d3748;
            margin-bottom: 8px;
        }

        .chooser-list {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .chooser-tag {
            background: #667eea;
            color: white;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.85em;
        }

        .comments-section {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 2px solid #e2e8f0;
        }

        .comments-title {
            font-weight: bold;
            color: #2d3748;
            margin-bottom: 8px;
        }

        .comment {
            background: #f7fafc;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 8px;
        }

        .comment-author {
            font-weight: 600;
            color: #667eea;
            font-size: 0.9em;
        }

        .comment-text {
            color: #4a5568;
            margin-top: 4px;
            font-size: 0.95em;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 12px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-content h2 {
            margin-bottom: 20px;
            color: #2d3748;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #2d3748;
        }

        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #e2e8f0;
            border-radius: 6px;
            font-size: 14px;
            font-family: inherit;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }

        .form-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .empty-state {
            text-align: center;
            color: white;
            padding: 60px 20px;
        }

        .empty-state h2 {
            font-size: 2em;
            margin-bottom: 10px;
        }

        .sync-indicator {
            font-size: 0.85em;
            color: #718096;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>CS 4360 Project Whiteboard</h1>
        <p>Share your ideas and choose projects to collaborate on</p>
    </div>

    <div class="user-info">
        <div>
            <span class="user-name" id="userName">Loading...</span>
            <span class="sync-indicator" id="syncIndicator">● Syncing...</span>
        </div>
        <div>
            <button onclick="changeUser()" class="btn-secondary">Change Name</button>
            <button onclick="showModeratorModal()" class="btn-danger">Moderate</button>
        </div>
    </div>

    <div class="controls">
        <button onclick="showAddProjectModal()" class="btn-primary">+ Add Project Idea</button>
    </div>

    <div class="board" id="board">
        <div class="empty-state">
            <h2>No projects yet</h2>
            <p>Be the first to add a project idea!</p>
        </div>
    </div>

    <!-- Add Project Modal -->
    <div class="modal" id="addProjectModal">
        <div class="modal-content">
            <h2>Add Project Idea</h2>
            <div class="form-group">
                <label>Project Title *</label>
                <input type="text" id="projectTitle" placeholder="Enter project title">
            </div>
            <div class="form-group">
                <label>Who does this benefit? *</label>
                <input type="text" id="projectWho" placeholder="e.g., Elementary school students">
            </div>
            <div class="form-group">
                <label>What is the benefit? *</label>
                <textarea id="projectWhat" placeholder="Describe the benefit or impact..."></textarea>
            </div>
            <div class="form-actions">
                <button onclick="addProject()" class="btn-primary">Add Project</button>
                <button onclick="closeModal('addProjectModal')" class="btn-secondary">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Add Comment Modal -->
    <div class="modal" id="addCommentModal">
        <div class="modal-content">
            <h2>Add Comment/Contribution</h2>
            <div class="form-group">
                <label>Your Comment *</label>
                <textarea id="commentText" placeholder="Share your thoughts or ideas..."></textarea>
            </div>
            <div class="form-actions">
                <button onclick="addComment()" class="btn-primary">Add Comment</button>
                <button onclick="closeModal('addCommentModal')" class="btn-secondary">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Moderator Modal -->
    <div class="modal" id="moderatorModal">
        <div class="modal-content">
            <h2>Moderator Access</h2>
            <div class="form-group">
                <label>Password</label>
                <input type="password" id="modPassword" placeholder="Enter moderator password">
            </div>
            <div class="form-actions">
                <button onclick="clearBoard()" class="btn-danger">Clear Entire Board</button>
                <button onclick="closeModal('moderatorModal')" class="btn-secondary">Cancel</button>
            </div>
        </div>
    </div>

    <!-- User Name Modal -->
    <div class="modal" id="userNameModal">
        <div class="modal-content">
            <h2>Welcome!</h2>
            <div class="form-group">
                <label>Enter Your Name *</label>
                <input type="text" id="userNameInput" placeholder="Your name">
            </div>
            <div class="form-actions">
                <button onclick="setUserName()" class="btn-primary">Continue</button>
            </div>
        </div>
    </div>

    <script>
        const MODZ = 'admin321';
        const SYNC_INTERVAL = 5000; // 5 seconds
        let currentUser = '';
        let currentProjectId = null;
        let syncTimer = null;

        // Initialize app
        async function init() {
            try {
                const storedUser = await window.storage.get('currentUser');
                if (storedUser && storedUser.value) {
                    currentUser = storedUser.value;
                    document.getElementById('userName').textContent = `Logged in as: ${currentUser}`;
                    loadProjects();
                    startSync();
                } else {
                    showModal('userNameModal');
                }
            } catch (error) {
                showModal('userNameModal');
            }
        }

        async function setUserName() {
            const nameInput = document.getElementById('userNameInput');
            const name = nameInput.value.trim();
            if (!name) {
                alert('Please enter your name');
                return;
            }
            currentUser = name;
            await window.storage.set('currentUser', name);
            document.getElementById('userName').textContent = `Logged in as: ${currentUser}`;
            closeModal('userNameModal');
            loadProjects();
            startSync();
        }

        async function changeUser() {
            document.getElementById('userNameInput').value = currentUser;
            showModal('userNameModal');
        }

        function startSync() {
            if (syncTimer) clearInterval(syncTimer);
            syncTimer = setInterval(() => {
                loadProjects();
                updateSyncIndicator();
            }, SYNC_INTERVAL);
        }

        function updateSyncIndicator() {
            const indicator = document.getElementById('syncIndicator');
            indicator.textContent = '● Synced';
            setTimeout(() => {
                indicator.textContent = '○ Syncing...';
            }, 1000);
        }

        async function loadProjects() {
            try {
                const result = await window.storage.list('project:', true);
                const projects = [];
                
                if (result && result.keys) {
                    for (const key of result.keys) {
                        try {
                            const projectData = await window.storage.get(key, true);
                            if (projectData && projectData.value) {
                                projects.push(JSON.parse(projectData.value));
                            }
                        } catch (error) {
                            console.error('Error loading project:', error);
                        }
                    }
                }

                renderProjects(projects);
            } catch (error) {
                console.error('Error loading projects:', error);
                renderProjects([]);
            }
        }

        function renderProjects(projects) {
            const board = document.getElementById('board');
            
            if (projects.length === 0) {
                board.innerHTML = `
                    <div class="empty-state">
                        <h2>No projects yet</h2>
                        <p>Be the first to add a project idea!</p>
                    </div>
                `;
                return;
            }

            board.innerHTML = projects.map(project => `
                <div class="project-card">
                    <div class="project-title">${escapeHtml(project.title)}</div>
                    <div class="project-proposer">Proposed by: ${escapeHtml(project.proposer)}</div>
                    <div class="project-description">
                        <strong>Who:</strong> ${escapeHtml(project.who)}<br>
                        <strong>What:</strong> ${escapeHtml(project.what)}
                    </div>
                    <div class="project-actions">
                        ${project.choosers.includes(currentUser) 
                            ? `<button onclick="removeChoice('${project.id}')" class="btn-danger">Remove My Choice</button>`
                            : `<button onclick="chooseProject('${project.id}')" class="btn-primary">Choose This Project</button>`
                        }
                        <button onclick="showCommentModal('${project.id}')" class="btn-secondary">Add Comment</button>
                    </div>
                    ${project.choosers.length > 0 ? `
                        <div class="choosers">
                            <div class="choosers-title">Students who chose this (${project.choosers.length}):</div>
                            <div class="chooser-list">
                                ${project.choosers.map(name => `<span class="chooser-tag">${escapeHtml(name)}</span>`).join('')}
                            </div>
                        </div>
                    ` : ''}
                    ${project.comments.length > 0 ? `
                        <div class="comments-section">
                            <div class="comments-title">Comments & Contributions:</div>
                            ${project.comments.map(comment => `
                                <div class="comment">
                                    <div class="comment-author">${escapeHtml(comment.author)}</div>
                                    <div class="comment-text">${escapeHtml(comment.text)}</div>
                                </div>
                            `).join('')}
                        </div>
                    ` : ''}
                </div>
            `).join('');
        }

        async function addProject() {
            const title = document.getElementById('projectTitle').value.trim();
            const who = document.getElementById('projectWho').value.trim();
            const what = document.getElementById('projectWhat').value.trim();

            if (!title || !who || !what) {
                alert('Please fill in all fields');
                return;
            }

            const project = {
                id: 'project:' + Date.now(),
                title,
                who,
                what,
                proposer: currentUser,
                choosers: [],
                comments: [],
                createdAt: new Date().toISOString()
            };

            try {
                await window.storage.set(project.id, JSON.stringify(project), true);
                closeModal('addProjectModal');
                document.getElementById('projectTitle').value = '';
                document.getElementById('projectWho').value = '';
                document.getElementById('projectWhat').value = '';
                loadProjects();
            } catch (error) {
                alert('Error adding project: ' + error.message);
            }
        }

        async function chooseProject(projectId) {
            try {
                const projectData = await window.storage.get(projectId, true);
                if (projectData && projectData.value) {
                    const project = JSON.parse(projectData.value);
                    if (!project.choosers.includes(currentUser)) {
                        project.choosers.push(currentUser);
                        await window.storage.set(projectId, JSON.stringify(project), true);
                        loadProjects();
                    }
                }
            } catch (error) {
                alert('Error choosing project: ' + error.message);
            }
        }

        async function removeChoice(projectId) {
            try {
                const projectData = await window.storage.get(projectId, true);
                if (projectData && projectData.value) {
                    const project = JSON.parse(projectData.value);
                    project.choosers = project.choosers.filter(name => name !== currentUser);
                    await window.storage.set(projectId, JSON.stringify(project), true);
                    loadProjects();
                }
            } catch (error) {
                alert('Error removing choice: ' + error.message);
            }
        }

        function showCommentModal(projectId) {
            currentProjectId = projectId;
            showModal('addCommentModal');
        }

        async function addComment() {
            const text = document.getElementById('commentText').value.trim();
            if (!text) {
                alert('Please enter a comment');
                return;
            }

            try {
                const projectData = await window.storage.get(currentProjectId, true);
                if (projectData && projectData.value) {
                    const project = JSON.parse(projectData.value);
                    project.comments.push({
                        author: currentUser,
                        text,
                        createdAt: new Date().toISOString()
                    });
                    await window.storage.set(currentProjectId, JSON.stringify(project), true);
                    closeModal('addCommentModal');
                    document.getElementById('commentText').value = '';
                    loadProjects();
                }
            } catch (error) {
                alert('Error adding comment: ' + error.message);
            }
        }

        function showModeratorModal() {
            showModal('moderatorModal');
        }

        async function clearBoard() {
            const check = document.getElementById('modPassword').value;
            if (check !== MODZ) {
                alert('Incorrect password');
                return;
            }

            if (!confirm('Are you sure you want to clear the entire board? This cannot be undone.')) {
                return;
            }

            try {
                const result = await window.storage.list('project:', true);
                if (result && result.keys) {
                    for (const key of result.keys) {
                        await window.storage.delete(key, true);
                    }
                }
                closeModal('moderatorModal');
                document.getElementById('modPassword').value = '';
                loadProjects();
            } catch (error) {
                alert('Error clearing board: ' + error.message);
            }
        }

        function showAddProjectModal() {
            showModal('addProjectModal');
        }

        function showModal(modalId) {
            document.getElementById(modalId).classList.add('active');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Initialize on load
        init();
    </script>
</body>
</html>
